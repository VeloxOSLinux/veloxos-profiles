# ==========================================
# kernels.cfg - Manjaro-tools (miso) robust
# Auto-detect CachyOS-BORE kernel + initramfs
# ==========================================

# Optional: make sure we can use cpuid if present
if insmod cpuid; then
    true
fi

# --- Detect CPU 64-bit capability (do not hard-fail if cpuid missing) ---
set have64="unknown"
if command -v cpuid; then
    if cpuid -l; then
        set have64="true"
    else
        set have64="false"
    fi
else
    set have64="unknown"
fi

# --- Find kernel/initramfs on the ISO ---
set have_kernel="false"
set kernel_path=""
set initrd_path=""

# 1) Set root by searching for likely kernel filenames (reliable!)
for k in \
    /boot/vmlinuz-x86_64-linux-cachyos-bore \
    /boot/vmlinuz-linux-cachyos-bore \
    /boot/vmlinuz-x86_64-*cachyos*bore* \
    /boot/vmlinuz-*cachyos*bore* \
    /boot/vmlinuz-x86_64-*bore* \
    /boot/vmlinuz-*bore*
do
    # search will set root to the device containing this file (if any)
    if search --no-floppy --file --set=root "$k"; then
        if [ -e "$k" ]; then
            set kernel_path="$k"
            set have_kernel="true"
            break
        fi
    fi
done

# 2) If we found a kernel, find a matching initramfs
if [ "$have_kernel" = "true" ]; then
    for i in \
        /boot/initramfs-x86_64-linux-cachyos-bore.img \
        /boot/initramfs-linux-cachyos-bore.img \
        /boot/initramfs-x86_64-*bore*.img \
        /boot/initramfs-*bore*.img \
        /boot/initramfs-x86_64-*.img \
        /boot/initramfs-*.img
    do
        if [ -e "$i" ]; then
            set initrd_path="$i"
            break
        fi
    done
fi

# --- Menu entries ---
if [ "$have_kernel" != "true" ]; then
    menuentry "NO SUITABLE KERNELS AVAILABLE" {
        echo "No CachyOS-BORE kernel found on ISO under /boot/."
        echo "Hint: check /boot/vmlinuz* and initramfs* names."
        sleep 5
    }
else
    menuentry "Boot VeloxOS (CachyOS-BORE) [miso auto]" --class veloxos {
        set gfxpayload=keep

        # Safety: re-locate root again for the chosen kernel (in case devices changed)
        search --no-floppy --file --set=root "$kernel_path"

        # Compose cmdline: keep your variables if they are defined upstream
        # (install_dir/imglabel/kopts are expected from your main grub.cfg)
        linux "$kernel_path" misobasedir=$install_dir misolabel=$imglabel $kopts driver=free quiet splash

        # Load microcode only if present + initramfs if found
        if [ -e /boot/intel_ucode.img ]; then
            if [ -e /boot/amd_ucode.img ]; then
                if [ -n "$initrd_path" ]; then
                    initrd /boot/intel_ucode.img /boot/amd_ucode.img "$initrd_path"
                else
                    initrd /boot/intel_ucode.img /boot/amd_ucode.img
                fi
            else
                if [ -n "$initrd_path" ]; then
                    initrd /boot/intel_ucode.img "$initrd_path"
                else
                    initrd /boot/intel_ucode.img
                fi
            fi
        else
            if [ -e /boot/amd_ucode.img ]; then
                if [ -n "$initrd_path" ]; then
                    initrd /boot/amd_ucode.img "$initrd_path"
                else
                    initrd /boot/amd_ucode.img
                fi
            else
                if [ -n "$initrd_path" ]; then
                    initrd "$initrd_path"
                else
                    echo "WARNING: initramfs not found. Boot will likely fail."
                    sleep 5
                fi
            fi
        fi
    }
fi

